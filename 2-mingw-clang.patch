diff --git a/contrib/buildsystems/CMakeLists.txt b/contrib/buildsystems/CMakeLists.txt
index 2cab53b630..0938709289 100644
--- a/contrib/buildsystems/CMakeLists.txt
+++ b/contrib/buildsystems/CMakeLists.txt
@@ -276,7 +275,7 @@ endif()

 #Platform Specific
 if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
-       if(CMAKE_C_COMPILER_ID STREQUAL "MSVC" OR CMAKE_C_COMPILER_ID STREQUAL "Clang")
+       if(CMAKE_C_COMPILER_ID STREQUAL "MSVC")
                include_directories(${CMAKE_SOURCE_DIR}/compat/vcbuild/include)
                add_compile_definitions(_CRT_SECURE_NO_WARNINGS _CRT_NONSTDC_NO_DEPRECATE)
        endif()
@@ -706,13 +705,20 @@ list(TRANSFORM reftable_SOURCES PREPEND "${CMAKE_SOURCE_DIR}/")
 add_library(reftable STATIC ${reftable_SOURCES})

 if(WIN32)
-       if(NOT MSVC)#use windres when compiling with gcc and clang
+       if(NOT MSVC AND NOT CMAKE_C_COMPILER_ID STREQUAL "Clang")#use windres when compiling with gcc and clang
                add_custom_command(OUTPUT ${CMAKE_BINARY_DIR}/git.res
                                COMMAND ${WINDRES_EXE} -O coff -DMAJOR=${PROJECT_VERSION_MAJOR} -DMINOR=${PROJECT_VERSION_MINOR}
                                        -DMICRO=${PROJECT_VERSION_PATCH} -DPATCHLEVEL=0 -DGIT_VERSION="\\\"${PROJECT_VERSION}.GIT\\\""
                                        -i ${CMAKE_SOURCE_DIR}/git.rc -o ${CMAKE_BINARY_DIR}/git.res
                                WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
                                VERBATIM)
+       elseif(CMAKE_C_COMPILER_ID STREQUAL "Clang")
+               add_custom_command(OUTPUT ${CMAKE_BINARY_DIR}/git.res
+                               COMMAND ${WINDRES_EXE} -O coff -DMAJOR=${PROJECT_VERSION_MAJOR} -DMINOR=${PROJECT_VERSION_MINOR}
+                                       -DMICRO=${PROJECT_VERSION_PATCH} -DPATCHLEVEL=0 -DGIT_VERSION="${PROJECT_VERSION}.GIT"
+                                       -i ${CMAKE_SOURCE_DIR}/git.rc -o ${CMAKE_BINARY_DIR}/git.res
+                               WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
+                               VERBATIM)
        else()#MSVC use rc
                add_custom_command(OUTPUT ${CMAKE_BINARY_DIR}/git.res
                                COMMAND ${CMAKE_RC_COMPILER} /d MAJOR=${PROJECT_VERSION_MAJOR} /d MINOR=${PROJECT_VERSION_MINOR}
@@ -740,7 +746,7 @@ if(WIN32)
        if(CMAKE_C_COMPILER_ID STREQUAL "GNU")
                target_link_options(common-main PUBLIC -municode -Wl,--nxcompat -Wl,--dynamicbase -Wl,--pic-executable,-e,mainCRTStartup)
        elseif(CMAKE_C_COMPILER_ID STREQUAL "Clang")
-               target_link_options(common-main PUBLIC -municode -Wl,-nxcompat -Wl,-dynamicbase -Wl,-entry:wmainCRTStartup -Wl,invalidcontinue.obj)
+               target_link_options(common-main PUBLIC -municode -Wl,-nxcompat -Wl,-dynamicbase -Wl,-e,mainCRTStartup)
        elseif(CMAKE_C_COMPILER_ID STREQUAL "MSVC")
                target_link_options(common-main PUBLIC /IGNORE:4217 /IGNORE:4049 /NOLOGO /ENTRY:wmainCRTStartup /SUBSYSTEM:CONSOLE invalidcontinue.obj)
        else()